---
weight: 20
---

# 主从切换异常

## 问题描述
PostgreSQL 集群在主从切换时出现异常，可能导致：
- 切换时间过长
- 数据不一致
- 服务中断

## 常见原因
1. 网络分区
2. 存储性能问题
3. 配置不当
4. 资源不足

## 排查步骤

### 1. 检查集群状态
```bash
kubectl get postgresql <集群名称> -o yaml
```

关注字段：
- status.PostgresClusterStatus
- status.master
- status.pods

### 2. 查看 Patroni 日志
```bash
kubectl logs <pod名称> -c patroni
```

关键日志：
- Leader 选举过程
- 故障检测信息
- 切换时间戳

### 3. 检查复制状态
```bash
kubectl exec -it <pod名称> -c postgres -- psql -c "\x" -c "select * from pg_stat_replication;"
```

关注字段：
- state
- sync_state
- replay_lag

### 4. 验证网络连接
```bash
kubectl exec -it <pod名称> -c postgres -- ping <其他节点IP>
```

## 解决方案

### 网络问题
1. 检查网络策略配置
2. 验证节点间连通性
3. 优化网络性能

### 存储问题
1. 检查存储性能指标
2. 优化 I/O 配置
3. 升级存储硬件

### 配置优化
1. 调整 Patroni 参数：
   - ttl
   - loop_wait
   - retry_timeout
2. 优化 PostgreSQL 配置：
   - wal_keep_segments
   - max_wal_senders

### 资源不足
1. 增加 CPU 和内存资源
2. 优化查询性能
3. 扩展集群节点

## 预防措施
1. 定期测试故障转移
2. 监控集群健康状态
3. 优化资源配置
4. 配置合理的告警阈值
