---
weight: 20
---

# 配置高可用 PostgreSQL 集群

## 功能简介
本指南介绍如何在 Kubernetes 上配置高可用的 PostgreSQL 集群，使用 Patroni 实现自动故障转移和集群管理。

## 使用场景
- 生产环境数据库部署
- 关键业务系统数据库
- 需要高可用保障的应用场景

## 前置条件
1. 已安装 PostgreSQL Operator
2. 配置了支持动态供给的存储类
3. 具有创建 CRD 资源的权限
4. 确保 Kubernetes 集群有足够资源（至少 3 个可用节点）

## 操作步骤

### 1. 创建高可用集群
```bash
cat <<EOF | kubectl create -n default -f -
apiVersion: acid.zalan.do/v1
kind: postgresql
metadata:
  name: pg-ha-cluster
spec:
  teamId: my-team
  numberOfInstances: 3
  postgresql:
    version: "14"
  resources:
    requests:
      cpu: "1"
      memory: 2Gi
    limits:
      cpu: "2"
      memory: 4Gi
  volume:
    size: 50Gi
    storageClass: ssd
  patroni:
    ttl: 30
    loop_wait: 10
    retry_timeout: 10
    maximum_lag_on_failover: 1048576
EOF
```

### 2. 验证集群状态
```bash
kubectl get postgresql pg-ha-cluster -o yaml
```

输出示例：
```yaml
status:
  PostgresClusterStatus: Running
  pods:
  - pg-ha-cluster-0
  - pg-ha-cluster-1
  - pg-ha-cluster-2
  master: pg-ha-cluster-0
```

### 3. 配置连接池（可选）
```bash
kubectl patch postgresql pg-ha-cluster --type='merge' -p '
spec:
  enableConnectionPooler: true
  connectionPooler:
    numberOfInstances: 2
    mode: "transaction"
'
```

### 4. 配置监控（可选）
```bash
kubectl patch postgresql pg-ha-cluster --type='merge' -p '
spec:
  enableLogicalBackup: true
  enableConnectionPooler: true
  enableReplicaConnectionPooler: true
'
```

## 参数说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| numberOfInstances | 3 | 集群节点数量（建议奇数） |
| patroni.ttl | 30 | 主节点租约时间（秒） |
| patroni.loop_wait | 10 | 状态检查间隔（秒） |
| patroni.retry_timeout | 10 | 重试超时时间（秒） |
| maximum_lag_on_failover | 1048576 | 最大允许的复制延迟（字节） |

## 操作结果验证
1. 查看集群状态是否为 Running
2. 确认所有 Pod 正常运行
3. 测试故障转移：
   ```bash
   kubectl delete pod pg-ha-cluster-0
   ```
   观察新的主节点选举过程

## 注意事项
1. 生产环境建议使用 SSD 存储
2. 合理配置资源限制
3. 定期测试故障转移
4. 配置监控告警
5. 做好数据备份

## 了解更多
- [高可用架构](../concepts/ha.mdx)
- [监控配置](../functions/35_monitor.mdx)
- [备份恢复](../functions/15_back_restore.mdx)
