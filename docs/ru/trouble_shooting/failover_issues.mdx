---
weight: 20
sourceSHA: 521782b869e454a49596541b931603734dff253f475b1efbddae20d33821536a
---

# Исключение переключения мастер-слейв

## Описание проблемы

Во время переключения между мастером и слейвом в кластере PostgreSQL происходит исключение, что может привести к:

- Увеличенному времени переключения
- Несоответствию данных
- Прерыванию обслуживания

## Распространенные причины

1. Сетевое разделение
2. Проблемы с производительностью хранения
3. Неправильно настроенные параметры
4. Недостаточно ресурсов

## Шаги по устранению неполадок

### 1. Проверка состояния кластера

```bash
kubectl get postgresql <cluster-name> -o yaml
```

Ключевые поля для внимания:

- status.PostgresClusterStatus
- status.master
- status.pods

### 2. Просмотр логов Patroni

```bash
kubectl logs <pod-name> -c patroni
```

Ключевые логи для проверки:

- Процесс выборов лидера
- Информация о выявлении неисправностей
- Временные метки переключения

### 3. Проверка статуса репликации

```bash
kubectl exec -it <pod-name> -c postgres -- psql -c "\x" -c "select * from pg_stat_replication;"
```

Ключевые поля для внимания:

- state
- sync\_state
- replay\_lag

### 4. Проверка сетевого соединения

```bash
kubectl exec -it <pod-name> -c postgres -- ping <other-node-IP>
```

## Решения

### Проблемы с сетью

1. Проверьте конфигурацию сетевой политики
2. Убедитесь в возможностях связи между узлами
3. Оптимизируйте сетевую производительность

### Проблемы с хранением

1. Проверьте метрики производительности хранения
2. Оптимизируйте конфигурацию ввода-вывода
3. Обновите оборудование для хранения

### Оптимизация конфигурации

1. Настройте параметры Patroni:
   - ttl
   - loop\_wait
   - retry\_timeout
2. Оптимизируйте конфигурацию PostgreSQL:
   - wal\_keep\_segments
   - max\_wal\_senders

### Недостаток ресурсов

1. Увеличьте ресурсы CPU и памяти
2. Оптимизируйте производительность запросов
3. Масштабируйте узлы кластера

## Профилактические меры

1. Регулярно тестируйте переключение на резервный узел
2. Следите за состоянием кластера
3. Оптимизируйте конфигурацию ресурсов
4. Настраивайте разумные пороговые значения для предупреждений
