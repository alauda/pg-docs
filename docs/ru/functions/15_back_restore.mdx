---
weight: 15
sourceSHA: 41e8805b18a79ade6a22039b641d66c404a04790aaa4304b242751fad9daa050
---

# Резервное копирование и восстановление

## Введение

Предоставляет возможности физического резервного копирования и восстановления на основе хранилища для обеспечения безопасности данных. Поддерживает ручное инициирование резервного копирования и восстановление на новые инстансы.

## Процедура

<Tabs>
  <Tab label="CLI">
    ### Настройка хранилища резервных копий

    ```bash
    # Пример: Настройка хранилища резервных копий для инстанса 'my-pg-instance'
    kubectl patch postgresql my-pg-instance -n my-namespace --type='merge' -p '
    spec:
      backup:
        retainDay: 7
        storage:
          name: my-s3-config
          bucket: my-backup-bucket
          namespace: storage-namespace
    '
    ```

    ### Создание резервной копии

    ```bash
    # Пример: Создание резервной копии с именем 'my-backup' для кластера 'my-pg-cluster'
    cat <<EOF | kubectl create -f -
    apiVersion: middleware.alauda.io/v1
    kind: PostgresBackup
    metadata:
      name: my-backup
      namespace: my-namespace
    spec:
      cluster: my-pg-cluster
      executeNode: my-pg-cluster-0  # Необязательно: укажите под для выполнения резервного копирования
    EOF
    ```

    ### Просмотр статуса резервной копии

    ```bash
    kubectl get postgresbackup <backup-name> -n <namespace> -o yaml
    ```

    ### Восстановление базы данных

    ```bash
    cat <<EOF | kubectl create -f -
    apiVersion: middleware.alauda.io/v1
    kind: PostgresRestore
    metadata:
      name: <restore-instance-name>
      namespace: <namespace>
    spec:
      backupCluster:
        name: <backup-pg-cluster-name>
        uid: <backup-pg-cluster-uid>
        storage:
          name: <storage-name>
          namespace: <storage-namespace>
          bucket: <s3-bucket-name>
      targetCluster: |
        apiVersion: acid.zalan.do/v1
        kind: postgresql
        metadata:
          name: <new-instance-name>
          namespace: <new-instance-namespace>
        spec:
          enableExporter: true
          enablePgpool2: false
          numberOfInstances: 2
          postgresql:
            version: "14"
          resources:
            limits:
              cpu: "1"
              memory: 2Gi
            requests:
              cpu: "1"
              memory: 2Gi
          teamId: ACID
          volume:
            size: 20Gi
            storageClass: sc-topolvm
      timestamp: "2023-07-26T14:36:38+00:00"  # Временная метка для восстановления
    EOF
    ```
  </Tab>

  <Tab label="Веб-консоль">
    1. Нажмите **PostgreSQL** в левом навигационном меню
    2. Выберите целевое пространство имен
    3. Выберите целевой инстанс из списка инстансов
    4. Нажмите на вкладку **Резервное копирование и восстановление**

    ### Настройка хранилища резервных копий

    1. Нажмите кнопку **Настроить хранилище**
    2. Заполните детали конфигурации хранилища:
       - Имя конфигурации хранилища
       - Имя корзины
       - Пространство имен конфигурации хранилища
       - Дни хранения резервных копий
    3. Нажмите **Сохранить**

    ### Создание резервной копии

    1. Нажмите кнопку **Создать резервную копию**
    2. Появится всплывающее окно с:
       - Имя инстанса (предварительно заполнено, например, pg-ha)
       - Тип: Основное резервное копирование (Полное резервное копирование)
    3. Нажмите **Создать**, чтобы начать резервное копирование, или **Отмена**, чтобы прервать

    После завершения резервного копирования, резервная копия появится в списке с:

    - ID: pg-ha-2025-03-25-092331
    - Время начала / окончания резервного копирования: С 2025-03-25 17:23:32 По 2025-03-25 17:23:33
    - Статус: Резервное копирование завершено

    ### Восстановление базы данных

    1. Нажмите кнопку **Восстановить базу данных**

    2. Загрузка страницы конфигурации восстановления:
       - Исходное имя инстанса (предварительно заполнено, например, pg-ha)
       - Восстановительный инстанс: Восстановить на новом инстансе (рекомендуется)
       - Метод восстановления: Восстановление по временной метке
       - Доступный диапазон времени (например, С 2025-03-25 17:23:34 По 2025-03-25 17:34:48)
       - Временная метка восстановления (выбираемая)

    3. Нажмите **Далее**, чтобы продолжить

    4. На странице конфигурации базовых параметров:
       - Введите имя (должно начинаться с буквы, заканчиваться буквой/цифрой, допустимы только строчные буквы и "-", максимум 30 символов)
       - Введите отображаемое имя
       - Выберите место развертывания
       - Выберите версию PostgreSQL (например, 11, 12, 14)
       - Установите количество реплик (например, 3)
       - Настройте требования к ресурсам:
         - CPU (например, 1 ядро)
         - Память (например, 2 Gi)
       - Выберите StorageClass (например, c1-topolvmsc)
       - Установите квоту на ресурсы хранилища (например, 50 Gi)
       - Настройте параметры планирования

    5. Нажмите **Восстановить**, чтобы начать процесс

    6. Вы будете перенаправлены на страницу деталей нового инстанса
  </Tab>
</Tabs>

## Описание статуса резервного копирования

Описание полей статуса резервного копирования:

| Поле                 | Описание                                 |
| --------------------- | ---------------------------------------- |
| backupName            | Имя файла резервной копии               |
| clusterUid            | Уникальный идентификатор кластера       |
| configBackupStorage   | Конфигурация хранилища резервных копий  |
| executeNode           | Узел, выполняющий резервное копирование   |
| finishLsn             | Позиция LSN в конце резервного копирования |
| finishTime            | Время завершения резервной копии         |
| lastModified          | Время последнего изменения резервной копии |
| pgVersion             | Версия PostgreSQL                       |
| startLsn              | Позиция LSN в начале резервного копирования |
| startTime             | Время начала резервного копирования      |
| state                 | Статус резервного копирования            |

## Предостережения

1. Конфигурация хранилища резервных копий должна быть завершена перед созданием резервной копии.
2. Операция восстановления создаст новый инстанс PostgreSQL.
3. Резервные копии будут автоматически удалены по истечении срока хранения.
4. Не выполняйте операции записи на исходном кластере во время процесса восстановления.
5. Убедитесь, что класс хранилища целевого кластера совместим с классом хранилища исходного кластера.
6. Проверьте наличие достаточного свободного места на диске перед началом резервного копирования.
7. Регулярно тестируйте процедуры восстановления для обеспечения действительности резервной копии.
8. Рассмотрите возможность включения шифрования резервных копий для чувствительных данных.
